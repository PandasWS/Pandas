# 更新日志

此仙境传说模拟器中值得注意的改动都将被记录到本文档.

虽然 Pandas 是基于 rAthena 构建的, 但我们不会刻意在此文档中强调 rAthena 官方的改动, 除非开发者认为 rAthena 的改动值得在此重点提出 (例如遇到兼容性问题时).

本文档遵循 [维护更新日志](https://keepachangelog.com/zh-CN/1.0.0/) 提及的格式标准, 但并不遵循 [语义化版本](https://semver.org/lang/zh-CN/) 版本号制定标准.

## 注意事项

若您运行本程序时遇到提示丢失 `VCRUNTIME140.dll` 等文件导致无法启动时, 请下载安装 [Microsoft Visual C++ 2015 Redistributable](https://www.microsoft.com/zh-CN/download/details.aspx?id=52685) 的 x86 版本后重试.

## [v1.1.1] - `2021-04-18`

### 升级

- 升级到 `1.1.1` 请在主数据库导入: `upgrade_to_1.1.1_main.sql`

### 添加

- 实现 `OnPCEnterMapExpress` 实时事件, 当玩家进入或切换地图时触发
- 实现 `OnPCUseReviveTokenFilter` 过滤器, 当玩家使用原地复活之证时触发
- 实现 `OnUnitKillExpress` 实时事件, 当某个单位被击杀时触发
- 实现 `OnPCUseOCIdentifyFilter` 过滤器, 当玩家使用一键鉴定时触发
- 实现 `getunittarget` 脚本指令, 用于获取指定单位当前正在攻击的目标单位编号
- 实现 `unlockcmd` 脚本指令, 用于解锁实时事件和过滤器事件中的指令限制
- 实现 `login` 脚本指令, 用于将指定的角色以特定的登录模式拉上线 (#354)
- 实现战斗记录机制并提供一系列脚本函数辅助构建输出 / 承伤排行榜 (#352)
- 拓展与 `bonus_script` 相关的脚本指令集 (引入唯一编号, 以及 5 个脚本指令) (#358)
- 拓展 `unitexists` 脚本指令, 增加可选参数用于要求目标单位必须存活才认为其存在
- 实现 `always_trigger_npc_killevent` 选项, 就算魔物有自定义死亡事件也能触发 OnNPCKillEvent
- 实现 `always_trigger_mvp_killevent` 选项, 就算 MVP 魔物有自定义死亡事件也能触发 OnPCKillMvpEvent

### 修正

- 修正 `maxdmg_skill` 和 `maxdmg_normal` 无法生效的问题 (感谢 "HongShin" 指出)
- 修正 FAW 魔法傀儡 (技能编号: 2282) 重复扣减原石碎片的问题 (#353)
- 修正 `progressbar` 期间使用 `@load` 或 `@jump` 会导致角色传送后无法移动的问题
- 修正 `progressbar` 期间使用 `@refresh` 会导致角色卡住的问题 (感谢"HongShin"指出)
- 修正 `mobremove` 指令会破坏魔物刷新点的问题 (感谢"喵了个咪"指出)
- 修正角色素质过高会导致无法召唤元素精灵的问题 (感谢 "HongShin" 反馈)
- 修正六维属性为负数时会导致角色面板数值溢出的问题 (感谢 "Renee" 反馈)
- 修正被踢下线的挂店角色在特定操作下会导致挂店数据不可信的问题
- 修正两处在 Ubuntu 下无法使用 GCC 编译通过的问题
- 修正辅助脚本在构建环境时会有多余的终端窗口没有立刻退出的问题

### 调整

- 完成绝大部分消息文件对繁体中文的支持 (#355)
- 将 `OnPCProgressAbortEvent` 改换成 `OnPCProgressAbortExpress` 实时事件
- 将全部事件名称以 Filter 结尾的过滤器事件调整为立刻执行 (不会被排入事件队列)
- 调整部分辅助脚本的工作逻辑, 减少流程阻碍
- 调整 `viewequip` 脚本指令的文档说明
- 调整 `copynpc` 指令的说明错误 (感谢"人鱼姬的思念"指出)

## [v1.1.0] - `2021-02-08`

### 升级

- 升级到 `1.1.0` 请在主数据库导入: `upgrade_to_1.1.0_main.sql`
- 由于 `Boost` 依赖项目变化, 请使用源码的同学重新编译 `3rdparty\boost` 工程
- 本次 `rAthena` 官方整合了多个物品数据文件到 `item_db.yml` 单文件中
- 本次 `rAthena` 官方提升 `quest_db.yml` 的数据版本 (从 1 调整为 2)
- 你在 `db\import\quest_db.yml` 中的 `Version` 应该从 1 调整为 2, 否则会有警告

### 提示

- rAthena 的调整同时也大幅改变了 SQL 版本物品数据库的字段结构
- 使用 SQL 版物品数据库的用户阅读: `sql-files/README.md`

### 添加

- 实现疾风缓存机制, 大幅提高缓存后加载 YAML 数据库的速度 (#336)
- 实现 `bNoFieldGemStone` 调整器, 可以让元素领域技能无需消耗魔力矿石 (#332)
- 支持读取 UTF8-BOM 的 libconfig 配置文件 (#348)

### 修正

- 修正复兴后 "魔术子弹"(GS_MAGICALBULLET) 的伤害溢出问题 (#331)
- 修正一处没有将指针置空导致的崩溃问题 (感谢 Renee / HongShin 协助) (#346)

### 调整

- 更新繁体中文的物品翻译对照表 (感谢 Renee 和 HongShin) (#340)
- 汉化部分战斗配置文件的注释选项 (#343 | #345)

## [v1.0.9] - `2021-01-29`

### 提示

- 建议所有使用 v1.0.8 的用户升级到 v1.0.9

### 修正

- 修正 v1.0.8 引入的手推车无法保存以及无法发送邮件的问题

## [v1.0.8] - `2020-11-20`

### 升级

- 升级到 `1.0.8` 请在主数据库导入: `upgrade_to_1.0.8_main.sql`

### 添加

- 实现支持多种单位的持久光环机制 (#324)
- 优化对极端计算的支持 (AKA: 变态服拓展包) (#326)
- 实现 `OnPCBuffStartExpress` 实时事件, 当玩家成功获得一个状态(Buff)后触发 (#329)
- 实现 `OnPCBuffStartFilter` 过滤器, 当玩家即将获得一个状态(Buff)时触发 (#329)
- 实现 `OnPCBuffEndExpress` 实时事件, 当玩家成功解除一个状态(Buff)后触发 (#330)

### 调整

- 使 Windows 环境下辅助脚本更容易被使用 (#325)
- 优化地图服务器启动时的加载速度 (#327)

## [v1.0.7] - `2020-09-13`

### 升级

- 升级到 `1.0.7` 请在主数据库导入: `upgrade_to_1.0.7_main.sql`
	- 若启用 `SQL` 版本的魔物/物品数据库, 那么还需导入: `upgrade_to_1.0.7_main_use_sql_db.sql`
- 升级到 `1.0.7` 请在日志数据库导入: `upgrade_to_1.0.7_logs.sql`

> 导入之前请打开 `sql` 文件查看顶部的注释信息, 通常会有一些导入顺序的建议.
> 请养成升级数据库之前备份的好习惯, 因为升级脚本并未经过大规模测试!!

### 提示

- 从该版本开始熊猫模拟器已支持 `20200401` 客户端, 但您需要自己修正 `PACKETVER` 并编译
- 考虑到目前大多数人没有稳定的 2020 客户端, 继续使用 `20180620` 作为默认客户端版本
- 该版本服务端侧已经支持 21 亿的物品编号, 但需要与客户端配套才能使用
- 经测试 `201806020` 的客户端并不支持超过 32767 的物品编号
- 基于 `RagexeRE` 制作的客户端版本 >= `20180704` 即可支持超过 32767 的物品编号
- 基于 `Ragexe` 制作的客户端版本 >= `20181121` 即可支持超过 32767 的物品编号
- 该版本中 rAthena 实装了 KRO 的职业调整, 会有大量技能效果变更, 附 KRO 更新日志:
	- [基因学者 - 2019.12.04](https://ro.gnjoy.com/news/update/View.asp?seq=246&curpage=1)
	- [人工生命体技能 - 2017.10.25](https://ro.gnjoy.com/news/event/View.asp?Seq=784&kind=A&curpage=1)
	- [修罗 - 2019.04.15](https://ro.gnjoy.com/news/notice/View.asp?seq=7099)
	- [日影忍者/月影忍者 - 2019.02.25](https://ro.gnjoy.com/news/notice/View.asp?BBSMode=10001&seq=7081)
	- [反叛者 - 2019.02.25](https://ro.gnjoy.com/news/notice/View.asp?BBSMode=10001&seq=7081)
	- [超级初学者 - 2019.02.25](https://ro.gnjoy.com/news/notice/View.asp?BBSMode=10001&seq=7081)
	- [吟游诗人/流浪舞姬 - 第一部分 - 2019.04.15](https://ro.gnjoy.com/news/update/View.asp?seq=235&curpage=1)
	- [吟游诗人/流浪舞姬 - 第二部分 - 2019.12.04](https://ro.gnjoy.com/news/update/View.asp?seq=246&curpage=1)
	- [十字刺客 - 2019.10.15](http://ro.gnjoy.com/news/update/View.asp?seq=243&curpage=1)
	- [大法师 - 2019.07.16](https://ro.gnjoy.com/news/update/View.asp?seq=239&curpage=1)
	- [卢恩骑士 - 第二部分 - 2019.10.15](https://ro.gnjoy.com/news/update/View.asp?seq=243&curpage=1)
	- [卢恩骑士 - 第一部分(早在2017年就已实装, 并非本次更新) - 2017.04.06](https://ro.gnjoy.com/news/devnote/View.asp?category=1&seq=3708477&curpage=1)
	
### 添加

- 实现 `nohomun` 地图标记, 用于禁止在指定地图召唤人工生命体 (#315)
- 实现 `nomerc` 地图标记, 用于禁止在指定地图召唤佣兵 (#316)
- 实现 `noskill2` 地图标记, 用于限制指定类型的单位在地图上使用技能 (#317)
- 实现 `getconstant` 脚本指令, 用于查询一个常量字符串对应的数值 (#318)
- 使 `getiteminfo` 可获取物品使用脚本/装备脚本/卸装脚本的内容 (#319)
- 实现 `preg_search` 脚本指令, 用于执行一个正则表达式搜索并返回匹配的分组内容 (#320)
- 使服务端能够读取 SSO 方式登录的用户本地 MAC 地址 (#309)

### 修正

- 处理 `Windows 10` 的 `UTF8` 编码选项带来的中文乱码问题 (#301)
- 修正部分情况下魔物会被随机传送或者卡住无法移动的问题 (感谢"张大坏"反馈) (#292)
- 修正 Liunx 环境下因为编码自适应导致的崩溃问题 (#298)
- 修正部分装备无法在背包和装备面板中显示的问题 (感谢"喵了个咪"反馈) (#303)
- 修正点击副本销毁按钮可能会导致地图服务器无响应的问题 (感谢"喵了个咪"反馈)
- 修正一些已知会导致崩溃的情况 (感谢"张大坏"反馈) (#308)
- 修正多层脚本堆栈备份恢复时的一处错误 (#312)
- 修正当 `block_free` 存在重复指针时的无效指针的问题 (感谢"喵了个咪"反馈) (#313)

### 调整

- 解除 `statuscheck` 脚本指令 `@sc_tickleft` 返回值的上限
- 使用 `pipenv` 对辅助脚本的依赖库进行管理维护 (合理性和使用难度同时提高) (#311)
- 汉化部分服务器消息文件和帮助文档 (#307)

## [v1.0.6] - `2020-06-11`

### 升级

- 升级到 `1.0.6` 请在主数据库导入: `upgrade_to_1.0.6_main.sql`

### 添加

- 使离线挂店或挂机角色可以被 `recall` 指令独立召唤 (#279)
- 实现 `nopet` 地图标记的功能, 可以在指定地图上禁止宠物 (#281)
- 实现 `setinventoryinfo` 脚本指令, 用于设置指定背包序号道具的部分详细信息 (#283) (#288)
- 使 `getinventoryinfo / setinventoryinfo` 可设置道具的绑定类型 (#289)

### 修正

- 修正 BOSS 雷达可能会地图服务器崩溃的问题 (感谢"小紀"反馈) (#267)
- 修正使用离线挂机系列指令会卡住公会仓库的问题 (感谢"喵了个咪"反馈) (#269)
- 修正魔物道具固定掉率数据库的 `StrictFixed` 字段无效的问题 (感谢 "张大坏" 反馈) (#272)
- 修正离线挂机/挂店的角色在服务器重启自动上线后头饰外观会暂时丢失的问题 (感谢 "张大坏" 反馈) (#273)
- 修正无效的技能编号可能导致潜在的地图服务器崩溃 (#276)
- 修正关闭地图服务器时若有副本正在运行时可能会导致崩溃的问题 (#277)
- 修正 `reloadscript` 可能会导致地图服务器崩溃的问题 (感谢"小紀"反馈) (#285)

### 调整

- 优化使用 `@version` 指令的回显信息 (#268)
- 打包时能够将物品和魔物名称转译成简体或繁体中文 (感谢"moonsun"提供译本) (#266)
- 使非 Windows 10 操作系统可以正常生成转储文件 (#271)
- 能够支持根据系统语言读取对应的消息文件 (#282)
- 整理数据库创建脚本的目录结构, 使之更加合理 (#286)

## [v1.0.5] - `2020-04-20`

### 升级

- 升级到 `1.0.5` 请在主数据库导入: `upgrade_to_1.0.5_main.sql`

### 添加

- 拓展离线挂机的不同种类, 延展出离线挂机模式和离开模式 (#260)

### 修正

- 修正 `nomail` 地图标记存在部分功能失效的问题 (#259)
- 修正使用 `delchar` 脚本指令会导致地图服务器崩溃的问题 (#263)
- 修正读取 UTF8-BOM 编码的文件时可能出现多余的空行 (#264)

### 调整

- 与 MySQL 数据库建立连接时主动禁用 SSL 模式 (#257)
- 将第三方组件模块 `libmysql.dll` 升级到 6.1.11 版本 (#258)
- 汉化部分行为明确的战斗配置选项描述和说明 (#261)
- 使公会的初始人数和扩充组合体制每级增加人数可被宏定义 (#262)
- 调整战斗配置选项与服务端不匹配时的一些错误提示 (#265)

## [v1.0.4] - `2020-03-23`

### 添加

- 添加 rAthenaCN 1.8.0 到熊猫模拟器的数据库升级脚本 (#251)
- 实现队长副本信息窗口中"销毁副本"按钮的功能 (#255)

### 修正

- 修正 `item_properties.yml` 部分设置无效的问题 (#252)
- 修正读取 `pet_db.yml` 可能导致的内存泄露 (#253)
- 修正 `getinventoryinfo` 获取道具 `unique_id` 错误的问题 (#254)

## [v1.0.3] - `2020-03-12`

### 升级

- 升级到 `1.0.3` 请在主数据库导入: `upgrade_to_1.0.3_main.sql`
- 由于 `Boost` 依赖项目变化, 请使用源码的同学重新编译 `3rdparty\boost` 工程
- 本次 `rAthena` 官方整合了多个技能数据文件到 `skill_db.yml` 单文件中
- 使用 `csv2yaml.exe` 可以将 `txt` 数据文件升级为 `yml` 格式的数据文件
- 你在 `conf\msg_conf\import\` 目录中用不到的 `map_msg_*_conf.txt` 可以删掉了

### 添加

- 实现终端信息翻译机制, 可跨平台自动适配英文、简体和繁体中文 (#226)
- 使战斗配置选项可限制玩家在 PVP 地图上的最大攻速 (#238)
- 使战斗配置选项可限制玩家在 GVG 地图上的最大攻速 (#239)
- 使 `item_properties.yml` 数据库能够屏蔽特定场景下的道具外观 (#236)
- 使 `item_properties.yml` 数据库能够设置高优先级的公告策略 (#244)
- 使战斗配置选项可控制玩家无权使用管理员指令时的处理方式 (#241)
- 使 `getsameipinfo` 指令能够支持指定地图 (#228)
- 实现 `storagegetitem` 脚本指令, 能够往仓库直接创造指定道具 (#233)

### 调整

- 使 `MAX_INVENTORY` 能够支持超过 128 的值 (#234)
- 归纳数据库升级脚本以便简化用户的升级操作, 请见 `sql-files` 目录 (#240)
- 优化读取物品数据库等几个比较明显的性能问题 (#229)
- 对消息文件的引入层级和关系进行梳理 (#243)
- 翻译登录, 角色, 地图服务器的主要配置文件 (#225)

### 修正

- 修正公会旗帜获取图标时提示 `map_getmapflag` 错误的问题 (感谢"小紀"反馈) (#231)
- 解决中文角色名在 Linux 终端上显示乱码的问题 (#227)
- 避免在 Windows 上部署 `import-tmpl` 目录时的冲突警告 (#237)
- 修正加载 `skill_db.yml` 潜在的一处崩溃问题 (#245)

## [v1.0.2] - `2019-11-29`

### 添加

- 实现 `selfdeletion` 脚本指令, 用于控制 NPC 在特定时机进行自毁 (#212)
- 实现 `npcexists` 脚本指令, 用于判断指定名称的 NPC 是否存在 (#220)
- 实现 `script4each` 系列指令使之能够支持调用事件标签 (#206)

### 调整

- 生成项目时若发现未编译 Boost 则会终止生成并给出操作提示 (#207)

### 修正

- 修正在部分 CPU 上运行 `VS2019 16.3` 编译出来的程序会崩溃的问题 (#210)
- 修正在 NPC 事件脚本代码中执行 `unloadnpc` 会导致地图服务器崩溃的问题 (#211)
- 跟随 a64a77b 修正语法解析判断的准确性问题 (感谢"Jian916"指出) (#208)
- 修正无法将转储文件发送到分析服务器的问题 (Part of #205)

## [v1.0.1] - `2019-11-03`

### 添加

- 实现 `multicatchpet` 脚本指令, 能够指定多个希望捕捉的魔物 (#189)
- 实现与装备穿脱相关的两个常规事件和两个过滤事件 (#191)
- 实现 `@crashtest` 管理员指令, 用于触发崩溃以便测试崩溃上报机制 (#193)
- 实现 `force_loadevent` 选项, 用于强制全部地图触发 `OnPCLoadMapEvent` 事件 (#194)
- 实现 `force_identified` 选项, 用于控制部分渠道创造的装备可直接变成已鉴定状态 (#196)
- 实现 `cashmount_useitem_limit` 选项, 用于限制使用 `商城坐骑` 时使用的道具类型 (#197)
- 实现 `script4eachmob` 和 `script4eachnpc` 脚本指令 (#201)

### 调整

- 拓展 `copynpc` 使其支持七个参数, 降低理解成本 (#190)
- 使 `script4each` 系列指令的 <脚本> 参数可以忽略最外层的大括号 (#200)

### 修正

- 修正启用多层脚本堆栈后会导致 `doevent` 表现异常的问题 (#185)
- 修正被中文紧挨着的待转义双引号无法通过语法检测的问题 (#203)

## [v1.0.0] - `2019-10-07`

### 添加

- 能够读取 `UTF8-BOM` 编码的 db, npc, conf 文件 (0a0606c)
- 实现护身符类型的道具, 只要道具在身上就能持续发挥效果 (#112)
- 实现魔物道具固定掉率数据库, 可用于设置道具的全局固定掉落概率 (#119)
- 使 `pointshop` 类型的商店能支持指定变量别名, 改善玩家的游戏体验 (#126)
- 使用 `Google Breakpad` 捕捉程序的崩溃转储文件 (#150)
- 能够检测 `import` 目录是否存在, 若不存在能自动复制一份出来 (#173)
- 重新梳理数据库连接配置并重写编码自动判定策略 (#174)
- 能够在 `map_athena.conf` 中设置封包混淆密钥 (a8d9e84)
- 能够在 `login_athena.conf` 中设置隐藏角色服务器的在线人数 (9291f57)
- 能够在 `char_athena.conf` 中设置禁止创建杜兰族角色 (30bfe00)
- 实现或拓展共计  1 个 GM 指令, 详见 `doc/pandas_atcommands.txt` 指令文档
- 实现或拓展共计 40 个脚本指令, 详见 `doc/pandas_script_commands.txt` 指令文档
- 实现或拓展共计 12 个地图标记, 详见 `doc/pandas_mapflags.txt` 说明文档
- 实现或拓展共计 15 个脚本事件, 详见 `doc/pandas_events.txt` 说明文档

### 调整

- 使影子装备可以支持插卡, 而不会因插卡而被强制转换成普通道具 (#64)
- 在使用 `_M/_F` 注册的时候, 能够限制使用中文等字符作为游戏账号 (09068b8)

### 修正

- 修正读取 `exp_homun.txt` 时提示信息不正确的问题 (#17)
- 修正部分简体、繁体中文字符作为角色名时, 会被变成问号的问题 (#50)
- 修正 `item_trade` 中限制物品掉落后, 权限足够的 GM 也无法绕过限制的问题 (#54)
- 修正使用 `sommon` 脚本指令召唤不存在的魔物, 会导致地图服务器崩溃的问题 (#65)
- 修正给予 `instance_create` 无效的副本名称会导致地图服务器崩溃的问题 (#113)
- 修正 `reloadnpc` 时文件路径前后有空格所带来的不良影响 (#139)
- 修正使用 `pointshop` 操作 `#CASHPOINTS` 变量时可能导致的双花攻击的问题 (#138)
- 修正多层脚本调用导致的程序崩溃问题 (#163)
- 修正部分情况下 `getd` 脚本指令会导致地图服务器崩溃的问题 (#175)
- 修正在部分情况下角色公会图标刷新不及时的问题 (663b9d4)

[v1.1.1]: https://github.com/PandasWS/Pandas/compare/v1.1.0...v1.1.1
[v1.1.0]: https://github.com/PandasWS/Pandas/compare/v1.0.9...v1.1.0
[v1.0.9]: https://github.com/PandasWS/Pandas/compare/v1.0.8...v1.0.9
[v1.0.8]: https://github.com/PandasWS/Pandas/compare/v1.0.7...v1.0.8
[v1.0.7]: https://github.com/PandasWS/Pandas/compare/v1.0.6...v1.0.7
[v1.0.6]: https://github.com/PandasWS/Pandas/compare/v1.0.5...v1.0.6
[v1.0.5]: https://github.com/PandasWS/Pandas/compare/v1.0.4...v1.0.5
[v1.0.4]: https://github.com/PandasWS/Pandas/compare/v1.0.3...v1.0.4
[v1.0.3]: https://github.com/PandasWS/Pandas/compare/v1.0.2...v1.0.3
[v1.0.2]: https://github.com/PandasWS/Pandas/compare/v1.0.1...v1.0.2
[v1.0.1]: https://github.com/PandasWS/Pandas/compare/v1.0.0...v1.0.1
[v1.0.0]: https://github.com/PandasWS/Pandas/releases/tag/v1.0.0
