# SQL 文件的说明

此目录中的所有文件主要都是基础的 SQL 表格构建脚本. 当全新安装或者是升级版本的时候, 可能都需要用到. 该文档主要对此目录下的文件进行介绍, 让大家对如何使用该目录中的各种文件有一个简单的了解.

特别是, 当 rAthena 开始将物品和其他数据库陆续从以前的 CSV 改造成 YAML 格式后, 数据库部分的内容有了较大的调整, 哪怕是老玩家也需要重新了解一下.


概念定义
============================================

熊猫模拟器基于 rAthena 模拟器构建, 可以看做是 rAthena 模拟器的 MOD 版. 他们的大多数基础概念是相同的, 但熊猫模拟器为了让初学者用户比较易懂, 将 sql-files 目录中的文件进行了挪动和重构, 因此它与 rAthena 的文件位置是不同的.

接下来会就一些基础的概念进行普及, 老玩家请跳过, 新玩家建议仔细阅读, 有助于你更好的使用熊猫模拟器或者避免一些初学者容易卡住的地方.

## 概念: 数据库服务器

熊猫模拟器想要正常运行, 就必然需要一个数据库服务器用来保存玩家的数据. 当前推荐使用 MySQL 作为数据库服务器. 之所以称之为是"服务器", 是因为它可以对外提供"数据"的存储和查询服务. 

一台数据库服务器会拥有它的 IP 和端口, 其中端口通常就是 3306, 还会有数据库服务器的账号密码. 外部程序必须知道 MySQL 服务器的 IP, 端口, 账号, 密码 这四个要素, 才能与数据库服务器建立连接, 才能有机会将数据保存到它上面去.

通常, 在 `conf/inter_athena.conf` 配置文件中, 我们会定义好几组与 MySQL 数据库服务器的连接配置, 详见对应文件中的说明信息. 但直接修改 `conf/inter_athena.conf` 并不是一个好主意, 最佳实践是: 将自己的改动存放到 `conf/import/inter_conf.txt` 中去, 这样未来当模拟器有更新时你可以放心的将 `conf/inter_athena.conf` 替换成最新版本模拟器的配套文件, 而无需担心又需要被重新配置一次.

* 一台 MySQL 数据库服务器 (Database Server) 可以存放多个数据库 (Database)
* 一个数据库 (Database) 可以存放多个数据表 (Table)
* 每一个数据表 (Table) 可以有多个字段 (Field)
* 数据表 (Table) 中的每一行, 称之为一条记录 (Record)

不严谨的比喻: 

* 每一个数据库可以相当于一个 Excel 文件
* 每一个数据表相当于这个 Excel 文件中的 Sheet
* 每一个字段相当于这个 Sheet 中的一列
* 每一条记录相当于这个 Sheet 中的一行

## 概念: 主数据库

用于存放玩家存档数据的数据库, 称之为"主数据库" (Main Database). 主数据库通常就是 `conf/inter_athena.conf::map_server_db` 配置的那一个数据库. 主数据库除了存放玩家的存档数据外, 通常还存放着一些程序运行所需要的数据表.

## 概念: 日志数据库

用于存放玩家在游戏中活动产生的各种日志记录的数据库, 称之为"日志数据库" (Logs Database). 日志数据库通常就是 `conf/inter_athena.conf::log_db_db` 配置的那一个数据库. 它可以和主数据库是同一个, 但通常我们建议分开. 因为主数据库的记录通常比较少但内容十分重要, 而日志数据库的记录会非常多却没那么重要. 当你未来需要对数据库进行备份的时候, 若主数据库和日志数据库都是相同的一个数据库, 备份文件的体积会非常大.

## 概念: 数据库编码

若您是简体中文用户, 建立数据库时选择的编码请使用 `gbk`; 若您是繁体中文用户, 建立数据库时选择的编码请使用 `big5`, 原则上不推荐使用 `utf8` 或 `utf8mb4`, 因为仙境传说的客户端在简体中文和繁体中文的工作模式下, 使用的编码就是 `gbk` 和 `big5`, 而不是 `utf8` 这种 unicode 编码.

若您使用熊猫模拟器, 那么 `conf/inter_athena.conf::default_codepage` 只需要维持默认选项 `auto` 即可. 程序会根据运行服务端程序的操作系统语言, 自动确定编码. 详见 `default_codepage` 选项的说明.


全新安装
============================================

当你全新安装熊猫模拟器的时候, 需要在你的数据库服务器中建立两个数据库. 一个是主数据库, 我们假定名称为 `pandas_main`, 另一个是日志数据库, 我们假定名称为 `pandas_logs`. 当你建立完成数据库之后, 需要通过 sql-files 目录中对应的 SQL 脚本来建立对应的数据表.

针对 [主数据库] 您需要进行的操作是:

* 将 `sql-files\main\creation` 目录中的 sql 文件按顺序导入到主数据库中:
    * `sql-files\main\creation\01.main.sql`
    * `sql-files\main\creation\02.roulette_default_data.sql`
* 其中 `optional` 存放着一些可选的脚本, 暂时不用管, 本文后续会提及他们的作用
* 其中 `use_sql_db` 存放着 SQL 版本的物品和魔物数据库的建库脚本, 一会儿我们会讲到

针对 [日志数据库] 您需要进行的操作是:

* 将 `sql-files\logs\creation` 目录中的 sql 文件按顺序导入到主数据库中:
    * `sql-files\logs\creation\01.logs.sql`

细心的同学会发现, 目录路径都是被刻意设计过的. `main` 表示主数据库, `creation` 表示建库脚本, 平级的还有 `upgrades` 表示升级脚本 (后续会讲), `optional` 表示可选. `common` 表示公用. 而 SQL 脚本文件的命名中, 开头的 `01`, `02` 则表示导入的顺序.

> 编码说明: 所有的 sql 脚本文件都是 UTF8 编码, 若您用于导入脚本的工具支持选择 sql 文件的编码, 那么请选择 UTF8. 新手经常搞混的是: 此处的 SQL 文件编码与数据库的编码是两个东西. 你的数据库可以是 `gbk` 或者 `big5` 编码, 但负责用来建立表格的 sql 文件, 它自身的编码就是 UTF8.

## SQL 版数据

若您的服务器配置成使用 SQL 版本的物品和魔物数据库, 那么还需在主数据库中额外导入一些脚本文件. 默认情况下熊猫模拟器并未开启此功能, 但若您手动将 `conf/inter_athena.conf::use_sql_db` 设为 `yes` 那么意味着程序将去主数据库中读取物品和魔物数据库, 而不是去 `db` 目录下读取那些 txt 和 yaml 文件.

如果您不知道我在说什么, 可以当做什么事情都没发生过, 确保 `conf/inter_athena.conf::use_sql_db` 为 `no` 然后直接跳过接下来的导入说明, 前往 `升级版本` 章节继续阅读.

针对 [主数据库] 您需要进行的操作是:

* 依序导入 `sql-files\main\creation\use_sql_db\common` 目录中的 sql 文件
    * 此公用目录中的 sql 文件, 无论您是复兴前还是复兴后, 都需要导入
* 若您的程序编译成了 `复兴前` 版本, 那么:
    * 请依序导入 `sql-files\main\creation\use_sql_db\pre-renewal` 目录中的 sql 文件
    * 此目录中的多个 sql 文件都需要按顺序导入, 顺序是重要的, 请不要乱序导入
* 若您的程序编译成了 `复兴后` 版本, 那么:
    * 请依序导入 `sql-files\main\creation\use_sql_db\renewal` 目录中的 sql 文件
    * 此目录中的多个 sql 文件都需要按顺序导入, 顺序是重要的, 请不要乱序导入
* 你可能会发现 `pre-renewal` 和 `renewal` 目录下有 `optional` (可选) 目录, 那里面的脚本暂时无需导入

> 写给老玩家: 以前 rAthena 中 item_db 可能只需要导入 1 个 sql 文件, 就已经包含了建表和数据内容汇入. 但最新的 rAthena 由于将物品数据库修改成 YAML 格式后, 将 SQL 版的物品数据库拆分成了四个文件, 其中 `item_db{_re}.sql` 负责建表, 剩下的 `item_db{_re}_{equip\usable\etc}.sql` 分别包含 `装备\可用物品\其他道具` 三大类道具的数据. 因此, 相比以前导入的 sql 文件多了好几个, 过程变得更为麻烦.


升级版本
============================================

随着时间的流逝, 模拟器会有功能上的更新和优化, 这有可能导致数据表的结构需要进行调整或者变更. 此时就需要对数据库进行升级操作. 在熊猫模拟器中用于升级数据库的脚本文件已经被重新归类和聚合整理, 通常每个版本只需要导入对应的升级脚本即可完成升级工作.

以 v1.0.6 升级到 v1.0.8 版本为例子, 我们举例说明应如何对数据库进行升级操作.

针对 [主数据库] 的升级操作如下:

* 首先停止服务端程序的运行
* 将你的 [主数据库] 完整的导出成 sql 脚本文件, 进行备份
* 打开 `sql-files\main\upgrades\upgrade_to_1.0.7_main.sql` 阅读顶部说明, 并将其导入
* 若启用了 `use_sql_db` 则还需打开 `sql-files\main\upgrades\upgrade_to_1.0.7_main_use_sql_db.sql` 阅读顶部说明, 并将其导入
* 上述两个文件导入完成后, 你的 [主数据库] 已经被升级到 v1.0.7
* 打开 `sql-files\main\upgrades\upgrade_to_1.0.8_main.sql` 阅读顶部说明, 并将其导入
* 此时你的 [主数据库] 已经被升级到 v1.0.8

针对 [日志数据库] 的升级操作如下:

* 首先停止服务端程序的运行
* 将你的 [日志数据库] 完整的导出成 sql 脚本文件, 进行备份
* 打开 `sql-files\logs\upgrades\upgrade_to_1.0.7_logs.sql` 阅读顶部说明, 并将其导入
* 该文件导入完成后, 你的 [日志数据库] 已经被升级到 v1.0.7
* 你会发现并没有 v1.0.8 的 [日志数据库] 升级文件, 这说明 v1.0.7 到 v1.0.8 之间, 日志数据库的结构没发生变化, 无需升级

## 升级注意事项

每一个 sql 文件都需要用 `Notepad++` 或 `Visual Studio Code` 等文本编辑器打开, 阅读顶部的导入说明. 有时候一些特殊版本可能涉及到更为复杂的导入策略, 会在每一个升级脚本文件的顶部进行单独的说明.

此外, 数据备份也非常重要. 熊猫模拟器仅在每次版本发布的时候, 在干净的数据库环境中测试升级脚本是可用的. 但并不对此进行任何的保证!! 因此, 当你自己尝试对数据库进行过结构变更, 那么升级脚本将无法保证 100% 兼容你的数据库, 升级过程可能会存在失败的情况. 数据无价, 多备份一下总是好的.

当版本更新时, 若需要涉及升级数据的操作, 在 `changelog.md` 更新日志中也会进行说明. 若没有进行升级说明, 则表示该版本无需进行任何数据库升级操作, 与其上个版本的数据库结构完全相同.


兼容老程序
============================================

从 v1.1.0 版本开始, rAthena 将物品数据库从以前的 CSV 格式改造成 YAML 格式, 与此同时也修改了 SQL 版数据的字段结构, 可以理解为 v1.0.9 版本和 v1.1.0 版本在 SQL 中的数据表完全是两个东西. 但是, 历史上我们会有很多外部程序, 例如 `FluxCP` 它会依赖 [主数据库] 中的 `item_db{_re}` 或 `item_db2{_re}`  内容, 来向访问站点的用户提供物品数据库的查询服务. 当 rAthena 变更了这两个表的数据结构之后, 毫无悬念的 `FluxCP` 物品数据库查询功能将会直接报错.

为了在过渡期间解决对类似 `FluxCP` 等外部程序的兼容问题, rAthena 提供了一套视图程序脚本, 用来对 `item_db{_re}` 或 `item_db2{_re}` 进行加工, 使之能变成回以前 `FluxCP` 能够识别和解析的数据库格式. 使用 "视图" 的好处在于它将自动使用 `item_db{_re}` 或 `item_db2{_re}` 中的数据, 您无需在更新 `item_db{_re}` 或 `item_db2{_re}` 的内容时, 还去刻意更新专门用于兼容的老数据表.

如果您有此需求, 请按以下步骤进行操作:

* 确保您已将 `item_db{_re}` 或 `item_db2{_re}` 升级到 v1.1.0 版本的结构
* 若您的程序编译成了 `复兴前` 版本, 那么:
    * 请依序导入 `sql-files\main\creation\use_sql_db\pre-renewal\optional` 目录中的 sql 文件
    * 完成后, 将会出现两个新的视图表: `item_db_compat` 和 `item_db2_compat`
* 若您的程序编译成了 `复兴后` 版本, 那么:
    * 请依序导入 `sql-files\main\creation\use_sql_db\renewal\optional` 目录中的 sql 文件
    * 完成后, 将会出现两个新的视图表: `item_db_re_compat` 和 `item_db2_re_compat`
* 配置你的 `FluxCP` 等外部工具, 使他们可以访问对应的视图表

> 小提示: 若您使用类似 Navicat 等数据库管理工具时, 如果发现导出视图表后无法在 Tables 中找到视图表, 这是正常的现象因为它并不是一个 "表", 因此请检查 "视图" 选项卡. 其他数据库管理工具也同理. 由于 "视图" 和 "数据表" 在查询上没有任何差异, 因此你可以将 "视图" 也理解成为一种特殊的 "数据表".


辅助工具
============================================

rAthena 官方提供了一些奇奇怪怪的辅助脚本, 通常在特定情况下有用. 由于实在是太低频了, 因此熊猫模拟器的发布版压缩包中并没有包含他们. 这些辅助脚本 (或者说: 工具) 存放在熊猫模拟器的源代码仓库的 `sql-files\tools` 目录中, 您可以随时访问: [https://github.com/PandasWS/Pandas/tree/master/sql-files/tools](https://github.com/PandasWS/Pandas/tree/master/sql-files/tools) 来下载使用它们.

虽然这些工具比较低频, 但既然 rAthena 提供了我们也就介绍一下:

* convert_engine_innodb.sql - 将你的数据库表引擎改成 InnoDB.
* convert_engine_myiasm.sql - 将你的数据库表引擎改成 MyISAM.
* convert_passwords.sql - 将登陆表 (login) 的密码字段转换成 MD5 (不可逆).

以下是一些辅助脚本用来帮助大家把物品数据库转换成以前常见的 TXT 格式. 在使用这些脚本之前, 需要提前做一些调整:

1. 先打开你要运行的 sql 文件, 修改其中 `INTO OUTFILE` 关键字后的 TXT 文件输出路径
2. 运行这些 sql 文件需要你的账号拥有 [文件](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_file) 权限.
3. 此外, 还需要调整 MySQL 服务器的配置的 [`secure-file-priv`](https://computingforgeeks.com/how-to-solve-mysql-server-is-running-with-the-secure-file-priv-error/) 选项
4. 随后你才能正常的使用这些脚本文件 (对初学者真是不友好呀)

以下是几个相关的 sql 文件说明:

* item_db_re_to_txt.sql - 将 `复兴后` 的物品数据库表转换成 TXT 格式.
* item_db_to_txt.sql - 将 `复兴前` 的物品数据库表转换成 TXT 格式.
* item_db2_re_to_txt.sql - 将 `复兴后` 的物品数据库表 (import) 转换成 TXT 格式.
* item_db2_to_txt.sql - 将 `复兴前` 的物品数据库表 (import) 转换成 TXT 格式.

> 小提示: 建议不要在生产环境中调整 `secure-file-priv` 等配置, 并不是非常的安全. 可以在开发环境中搭建一个 MySQL 服务器, 随便折腾.
